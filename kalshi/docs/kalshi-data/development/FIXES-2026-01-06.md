# Fixes Applied - 2026-01-06

Summary of bug fixes and documentation updates made to align implementation with documentation.

---

## Code Fixes

### 1. Trade Writer ON CONFLICT Fix

**File:** `internal/writer/trade.go:230`

**Problem:** `ON CONFLICT (trade_id)` didn't match the primary key `(trade_id, exchange_ts)` required by TimescaleDB hypertables.

**Fix:**
```go
// Before
ON CONFLICT (trade_id) DO NOTHING

// After
ON CONFLICT (trade_id, exchange_ts) DO NOTHING
```

### 2. Ticker Writer ON CONFLICT Fix

**File:** `internal/writer/ticker.go:231`

**Problem:** `ON CONFLICT (ticker, exchange_ts)` column order didn't match the primary key `(exchange_ts, ticker)`.

**Fix:**
```go
// Before
ON CONFLICT (ticker, exchange_ts) DO NOTHING

// After
ON CONFLICT (exchange_ts, ticker) DO NOTHING
```

### 3. ISO 8601 Timestamp Parsing

**File:** `internal/router/types.go:13-41`

**Problem:** Kalshi API now returns `ts` fields as ISO 8601 strings (e.g., `"2026-01-06T15:24:59.504579Z"`) instead of integer seconds. The `FlexInt64` type only handled numeric strings.

**Fix:** Added ISO 8601 parsing to `FlexInt64.UnmarshalJSON`:
```go
// Try parsing as ISO 8601 timestamp
t, err := time.Parse(time.RFC3339Nano, s)
if err != nil {
    return err
}
*f = FlexInt64(t.Unix())
```

---

## Documentation Updates

### API Documentation

Updated timestamp field documentation in:
- `docs/kalshi-api/websocket/channels/trades.md`
- `docs/kalshi-api/websocket/channels/orderbook.md`

Changed `ts` field type from `int` to `int or string` with note about ISO 8601 format.

### Data Model Documentation

Updated primary keys in both gatherer and production data model docs:
- `docs/kalshi-data/architecture/data-model.md`
- `docs/kalshi-data/architecture/data-model-production.md`

#### Primary Key Changes (TimescaleDB Requirement)

TimescaleDB hypertables require the partition column (time column) to be **first** in all unique constraints.

| Table | Old PK | New PK |
|-------|--------|--------|
| `trades` | `(trade_id)` | `(trade_id, exchange_ts)` |
| `orderbook_deltas` | `(ticker, exchange_ts, price, side)` | `(exchange_ts, ticker, price, side)` |
| `tickers` | `(ticker, exchange_ts)` | `(exchange_ts, ticker)` |
| `orderbook_snapshots` | `(ticker, snapshot_ts, source)` | `(snapshot_ts, ticker, source)` |

### ER Diagrams Updated

Both data model files now show correct PK columns with the partition column first.

---

## Verification

### Data Flowing Correctly

After fixes, all tables are receiving data:

| Table | Records |
|-------|---------|
| trades | ✓ |
| orderbook_deltas | ✓ |
| orderbook_snapshots | ✓ |
| tickers | ✓ |

### Sample Data

**Trade:**
```
trade_id:    fdd1a26f-cce3-47bc-f5e4-d27bb5a839b5
ticker:      KXTRUMPMENTIONB-26JAN07-TERR
price:       68000 ($0.68)
size:        10
taker_side:  yes
exchange_ts: 1767713354000000 (µs)
received_at: 1767713354091988 (µs)
```

**Ticker:**
```
ticker:       KXHIGHCHI-26JAN06-B47.5
exchange_ts:  1767713353000000 (µs)
yes_bid:      32000 ($0.32)
yes_ask:      40000 ($0.40)
last_price:   36000 ($0.36)
volume:       16180
open_interest: 11468
```

**Orderbook Delta:**
```
ticker:      KXSENATEMID-26-AELS
exchange_ts: 1767713362000000 (µs)
side:        yes
price:       19000 ($0.19)
size_delta:  +83
seq:         14
```

---

## Key Learnings

1. **TimescaleDB Constraint:** All unique indexes must include the partition column, and it must be first in composite keys.

2. **Kalshi API Evolution:** The API may return timestamps in different formats (integer seconds vs ISO 8601 strings). Code should handle both.

3. **Microsecond Precision:** All timestamps use microseconds (µs) since Unix epoch. The ISO 8601 strings from Kalshi include microsecond precision.
